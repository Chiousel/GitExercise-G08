{% extends 'market/base.html' %}

{% block title %}My Items - MMUBAY{% endblock %}

{% block content %}
<div class="container py-4">
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-boxes me-2"></i>My Items</h1>
        {% if pending_orders_count > 0 %}
            <div class="alert alert-warning mt-2">
                <i class="fas fa-bell me-2"></i>
                You have <strong>{{ pending_orders_count }}</strong> pending order(s) waiting for your response!
                <a href="#pending-orders" class="btn btn-sm btn-outline-warning ms-2">View Orders</a>
            </div>
        {% endif %}
    </div>
    <a href="{% url 'add_item' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Sell New Item
    </a>
</div>

    <div class="mb-5">
        <h3 class="text-success mb-3">
            <i class="fas fa-tags me-2"></i>Active Items ({{ active_items|length }})
        </h3>
        
        {% if active_items %}
            <div class="row">
                {% for item in active_items %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        {% if item.images.all %}
                            <img src="{{ item.images.first.image.url }}" 
                                 class="card-img-top item-image" 
                                 alt="{{ item.title }}">
                        {% else %}
                            <img src="https://via.placeholder.com/300x200?text=No+Image" 
                                 class="card-img-top item-image" 
                                 alt="No image">
                        {% endif %}
                        
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ item.title }}</h5>
                            <p class="text-muted small">{{ item.description|truncatewords:15 }}</p>
                            
                            <div class="mt-auto">
                                <div class="price-tag mb-2">RM{{ item.price }}</div>
                                <div class="d-flex gap-2">
                                    
                                    <form method="post" action="{% url 'my_items' %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" name="mark_sold" value="{{ item.id }}" 
                                                class="btn btn-success btn-sm"
                                                onclick="return confirm('Mark {{ item.title }} as sold?')">
                                            <i class="fas fa-check me-1"></i>Mark Sold
                                        </button>
                                    </form>
                                    
                                    
                                    <a href="{% url 'edit_item' item.id %}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </a>
                                    
                                    
                                    <a href="{% url 'item_detail' item.id %}" class="btn btn-outline-info btn-sm">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-muted small">
                            <i class="fas fa-clock me-1"></i>{{ item.created_at|timesince }} ago
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <p class="text-muted">You don't have any active items for sale.</p>
                <a href="{% url 'add_item' %}" class="btn btn-primary">Sell Your First Item</a>
            </div>
        {% endif %}
    </div>

    
{% if pending_orders_count > 0 %}
<div class="mb-5" id="pending-orders">
    <h3 class="text-warning mb-3">
        <i class="fas fa-clock me-2"></i>Pending Orders ({{ pending_orders_count }})
    </h3>
    
    <div class="row">
        {% for order in pending_orders %}  
            {% if order.status == 'pending' %}
            <div class="col-md-6 mb-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <strong>New Order!</strong>
                        <span class="float-end">#{{ order.id }}</span>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">{{ order.item.title }}</h6>
                        <p class="small mb-2">Price: <strong>RM{{ order.item.price }}</strong></p>
                        
                        
                        <div class="buyer-info mb-3 p-3 bg-light rounded">
                            <h6 class="text-primary">
                                <i class="fas fa-user me-1"></i>Buyer Information
                            </h6>
                            <p class="mb-1"><strong>Name:</strong> {{ order.buyer.username }}</p>
                            <p class="mb-1"><strong>Member since:</strong> {{ order.buyer.date_joined|date:"M Y" }}</p>
                            <a href="{% url 'view_profile' order.buyer.username %}" 
                               class="btn btn-sm btn-outline-primary mt-1">
                                <i class="fas fa-eye me-1"></i>View Buyer Profile
                            </a>
                        </div>
                        
                        
                        <div class="d-grid gap-2">
                            <form method="post" action="{% url 'accept_order' order.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm w-100"
                                        onclick="return confirm('Accept order for {{ order.item.title }}? This will mark the item as sold.')">
                                    <i class="fas fa-check me-1"></i>Accept Order & Mark as Sold
                                </button>
                            </form>
                            <small class="text-muted text-center">Order placed: {{ order.created_at|timesince }} ago</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

    
    <div class="mb-5">
        <h3 class="text-secondary mb-3">
            <i class="fas fa-check-circle me-2"></i>Sold Items ({{ sold_items|length }})
        </h3>
        
        {% if sold_items %}
            <div class="row">
                {% for item in sold_items %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm" style="opacity: 0.7;">
                        {% if item.images.all %}
                            <img src="{{ item.images.first.image.url }}" 
                                 class="card-img-top item-image" 
                                 alt="{{ item.title }}">
                        {% else %}
                            <img src="https://via.placeholder.com/300x200?text=No+Image" 
                                 class="card-img-top item-image" 
                                 alt="No image">
                        {% endif %}
                        
                        
                        <div class="position-absolute top-0 start-0 m-2">
                            <span class="badge bg-danger fs-6">SOLD</span>
                        </div>
                        
                        <div class="card-body">
                            <h5 class="card-title">{{ item.title }}</h5>
                            <p class="text-muted small">{{ item.description|truncatewords:10 }}</p>
                            <div class="price-tag text-muted">RM{{ item.price }}</div>
                        </div>
                         
                        <div class="mt-auto pt-3">
                            <form method="post" action="{% url 'delete_item' item.id %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="my_items">
                                <button type="submit" class="btn btn-danger btn-sm w-100"onclick="return confirm('Permanently delete \"{{ item.title }}\"? This cannot be undone.')">
                                    <i class="fas fa-trash me-1"></i>Delete Permanently
                                </button>
                            </form>
                        </div>
                        <div class="card-footer text-muted small">
                            <i class="fas fa-clock me-1"></i>Sold {{ item.updated_at|timesince }} ago
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-receipt fa-2x text-muted mb-2"></i>
                <p class="text-muted">No sold items yet.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
